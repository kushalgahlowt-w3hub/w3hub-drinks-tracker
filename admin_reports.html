<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>w3.hub – Admin Analytics</title>

    <!-- Shared styles -->
    <link rel="stylesheet" href="style.css">

    <!-- Chart + PDF libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Auth (route protection + logoutUser) -->
    <script defer src="auth.js"></script>

    <!-- Small page-specific styling -->
    <style>
        /* Greyed-out, disabled closed events in the event list */
        .event-checkbox-item.closed {
            opacity: 0.55;
        }

        .event-checkbox-item.closed span.status-pill {
            font-size: 11px;
            margin-left: 4px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .event-checkbox-item.open span.status-pill {
            font-size: 11px;
            margin-left: 4px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(184, 255, 181, 0.35);
        }

        .reopen-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
        }

        .reopen-row select {
            min-width: 220px;
        }

        .event-legend {
            font-size: 12px;
            margin-top: 6px;
            color: #9da2af;
        }
    </style>
</head>

<body>
<div class="layout">

    <!-- SIDEBAR (ADMIN ONLY) -->
    <aside class="sidebar" data-role="admin-only">
        <div class="sidebar-logo">
            <span class="logo-icon">w3</span><span class="logo-dot">.</span><span class="logo-text">hub</span>
        </div>
        <div class="sidebar-subtitle">Drinks Tracker • Internal tool</div>

        <nav class="sidebar-nav">
            <a href="dashboard.html">Setup · Events / Floors</a>
            <a href="runner.html">Runner Mode</a>
            <a href="storage.html">Storage / Deliveries</a>
            <a href="admin_reports.html" class="active">Analytics Dashboard</a>
            <a href="admin_users.html">User Management</a>
        </nav>

        <div class="sidebar-footer">
            <p>Property of w3.hub<br>Internal use only</p>
            <button onclick="logoutUser()" class="logout-btn">Logout</button>
        </div>
    </aside>

    <!-- SIDEBAR (RUNNER ONLY) -->
    <aside class="sidebar" data-role="runner-only" style="display:none;">
        <div class="sidebar-logo">
            <span class="logo-icon">w3</span><span class="logo-dot">.</span><span class="logo-text">hub</span>
        </div>
        <div class="sidebar-subtitle">Drinks Tracker • Internal tool</div>

        <nav class="sidebar-nav">
            <a href="runner.html">Runner Mode</a>
        </nav>

        <div class="sidebar-footer">
            <p>Property of w3.hub<br>Internal use only</p>
            <button onclick="logoutUser()" class="logout-btn">Logout</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">
        <div class="page-card">

            <h1>Admin Analytics Dashboard</h1>
            <p class="page-description">
                Aggregated drink consumption per event, floor, fridge &amp; drink type – with total value.
            </p>

            <!-- SUPABASE CLIENT (needed for admin_reports.js) -->
            <script>
                const SUPABASE_URL = "https://trcnszlkdunbbybdyjag.supabase.co";
                const SUPABASE_ANON_KEY =
                    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyY25zemxrZHVuYmJ5YmR5amFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODM4MTYsImV4cCI6MjA3ODk1OTgxNn0.wCAAHfsBOeU6rp4v_7JhdMI9NlucX1cT1_3GTZ0GR8M";

                const supabase = window.supabase.createClient(
                    SUPABASE_URL,
                    SUPABASE_ANON_KEY
                );
            </script>

            <!-- EVENT FILTER -->
            <section class="analytics-section">
                <h2>1. Select Events</h2>

                <div id="event-checkboxes" class="event-checkboxes"></div>
                <p id="events-status" class="status-text"></p>

                <p class="event-legend">
                    <strong>Legend:</strong>
                    <span>Open events – normal</span> ·
                    <span>Closed events – greyed and always included in analytics (runners cannot edit).</span>
                </p>

                <div style="display:flex; gap:12px; margin-top:10px; flex-wrap:wrap;">
                    <button id="apply-event-filter" class="btn-primary">
                        Apply Selection
                    </button>

                    <!-- CLOSE OPEN EVENTS -->
                    <button id="close-event-btn" class="btn-danger" type="button" style="display:none;">
                        Close Selected Events
                    </button>
                </div>

                <!-- REOPEN CLOSED EVENT -->
                <div id="reopen-event-wrapper" class="reopen-row" style="display:none;">
                    <span style="font-size:13px;">Reopen closed event:</span>
                    <select id="reopen-event-select"></select>
                    <button id="reopen-event-btn" class="btn-secondary" type="button">
                        Reopen Event
                    </button>
                </div>
            </section>

            <hr class="divider">

            <!-- CHARTS -->
            <section class="analytics-section">
                <h2>2. Charts</h2>
                <p class="page-description" id="charts-empty-message">
                    No data yet. Select at least one event with fridge logs.
                </p>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>By Drink Type</h3>
                        <canvas id="drink-pie-chart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3>By Fridge</h3>
                        <canvas id="fridge-bar-chart"></canvas>
                    </div>

                    <div class="chart-card">
                        <h3>Over Time</h3>
                        <canvas id="date-line-chart"></canvas>
                    </div>
                </div>
            </section>

            <hr class="divider">

            <!-- AGGREGATED TABLE -->
            <section class="analytics-section" id="drilldown-section">
                <h2>3. Aggregated Consumption</h2>
                <p class="page-description">
                    One row per Event · Floor · Fridge · Drink. Units consumed:
                    <strong>start + restock − end</strong>. Value = Units × Price (€).
                </p>

                <div class="drilldown-actions">
                    <button id="export-csv-btn" class="btn-secondary">Export CSV</button>
                    <button id="download-pdf-btn" class="btn-secondary">Download PDF</button>
                </div>

                <div class="table-wrapper">
                    <table class="history-table" id="drilldown-table">
                        <thead>
                        <tr>
                            <th>Event</th>
                            <th>Floor</th>
                            <th>Fridge</th>
                            <th>Drink</th>
                            <th>Units Consumed</th>
                            <th>Price / Unit (€)</th>
                            <th>Total Value (€)</th>
                            <th>Owner</th>
                        </tr>
                        </thead>
                        <tbody id="drilldown-body"></tbody>
                        <tfoot id="drilldown-footer"></tfoot>
                    </table>
                </div>
            </section>

        </div>
    </main>
</div>

<!-- Admin Analytics Logic -->
<script defer src="admin_reports.js"></script>

</body>
</html>








